<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>미국 주식 시가총액 근사 동적 그래프</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .ratio-box {
      margin-top: 20px;
      font-size: 16px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      width: 380px;
    }
  </style>
</head>
<body>
  <h3>미국 시가총액 1~3위 한달간 변화</h3>
  <div id="desc"></div>
  <canvas id="marketCapChart" width="720" height="340"></canvas>
  <div class="ratio-box" id="ratios"></div>
  <script>
    // 기초 데이터
    const symbols = ['NVDA', 'MSFT', 'AAPL'];
    const names = ['NVIDIA', 'Microsoft', 'Apple'];
    // 각 종목별 주식수(outstanding shares)
    const shares = {
      'NVDA': 24300000000,   // 243억주
      'MSFT':  7430000000,   // 74.4억주
      'AAPL': 14860000000    // 148억주
    };
    // 30일 기간(1달)
    const dtEnd = Math.floor(Date.now()/1000);
    const dtStart = dtEnd - (60*60*24*30);

    // Yahoo Finance 히스토리컬 데이터에서 종가만 추출
    async function fetchHistory(symbol) {
      const url = `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${dtStart}&period2=${dtEnd}&interval=1d`;
      const r = await fetch(url);
      const j = await r.json();
      // 데이터가 없는 날짜(예: 휴장일)는 건너뜀
      const timestamps = j.chart.result[0].timestamp;
      const closes = j.chart.result[0].indicators.adjclose[0].adjclose;
      // 날짜 문자열 배열 반환
      const dates = timestamps.map(ts => {
        const d = new Date(ts * 1000);
        return d.toISOString().slice(0,10);
      });
      // 시가총액 근사값: 종가 * 주식수 / 1조단위(USD, Trillion)
      const marketCaps = closes.map(close => +(close * shares[symbol] / 1e12).toFixed(2));
      return {dates, marketCaps};
    }

    async function main() {
      // 3종 데이터 병렬 fetch
      const res = await Promise.all(symbols.map(fetchHistory));
      // 기준 날짜 통일: 가장 긴 날짜 시퀀스 기준
      const labels = res[0].dates; // NVDA를 기준
      // 데이터: 날짜별 시가총액 배열
      const s1 = res[0].marketCaps;
      const s2 = res[1].marketCaps;
      const s3 = res[2].marketCaps;

      // Chart.js 그래프 그리기
      new Chart(document.getElementById('marketCapChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: names[0], data: s1, borderColor: 'rgb(60,180,75)', fill: false, tension: 0.25 },
            { label: names[1], data: s2, borderColor: 'rgb(0,130,200)', fill: false, tension: 0.25 },
            { label: names[2], data: s3, borderColor: 'rgb(245,130,48)', fill: false, tension: 0.25 }
          ]
        },
        options: {
          responsive: false,
          plugins: { legend: { position: 'top' } },
          scales: {
            y: { title: { display: true, text: '시가총액 (Trillion USD)' } },
            x: { title: { display: true, text: '날짜' } }
          }
        }
      });

      // 가장 마지막 날짜(최신값) 기준 시총 비율 계산
      const n = labels.length - 1;
      const ratio12 = (s1[n] / s2[n]).toFixed(2);
      const ratio23 = (s2[n] / s3[n]).toFixed(2);
      const ratio13 = (s1[n] / s3[n]).toFixed(2);

      document.getElementById('desc').innerHTML =
        `${labels[0]} ~ ${labels[n]} 기준 데이터 (단위: Trillion USD, 종가×발행주식수로 근사)`;

      document.getElementById('ratios').innerHTML = `
        NVIDIA / Microsoft = <b>${ratio12}</b><br>
        Microsoft / Apple = <b>${ratio23}</b><br>
        NVIDIA / Apple = <b>${ratio13}</b>
      `;
    }
    main();
  </script>
</body>
</html>
