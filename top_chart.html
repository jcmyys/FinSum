<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>미국 주식 시가총액 1~10위 (90일)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>
    .chart-button { background-color: #28a745; color: white; }
    .chart-button:hover { background-color: #218838; }
</style>
<body style="margin:0;padding:20px;background:#f0f2f5;height:100vh;display:flex;align-items:center;justify-content:center;">
    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
        <button onclick="window.location.href='index.html'" class="nav-btn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;"> 
            ← 메인 페이지로 이동
        </button>
    </div>
    <canvas id="marketCapChart" style="max-width:1400px;max-height:800px;width:100%;height:100%;background:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.1);"></canvas>

    <script>
        const symbols=['NVDA','MSFT','AAPL','GOOGL','AMZN','META','AVGO','TSLA','BRK-B','LLY'];
        const names={'NVDA':'NVIDIA','MSFT':'Microsoft','AAPL':'Apple','GOOGL':'Alphabet','AMZN':'Amazon','META':'Meta','AVGO':'Broadcom','TSLA':'Tesla','BRK-B':'Berkshire','LLY':'Eli Lilly'};
        const colors=['#00C49A','#FFBB28','#FF8042','#8884D8','#82CA9D','#A4DE6C','#D0ED57','#FF6B6B','#4ECDC4','#45B7D1'];
        const shares={'NVDA':24600000000,'MSFT':7430000000,'AAPL':15200000000,'GOOGL':12300000000,'AMZN':10450000000,'META':2600000000,'AVGO':4680000000,'TSLA':3200000000,'BRK-B':2160000000,'LLY':950000000};
        
        // 90일 (3개월) 데이터
        const dtEnd=Math.floor(Date.now()/1000);
        const dtStart=dtEnd-(90*24*60*60);  // 90일

        async function fetchHistory(symbol){
            try{
                console.log('Fetching ' + symbol + '...');
                const yahooUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/' + symbol + '?period1=' + dtStart + '&period2=' + dtEnd + '&interval=1d';
                const url = 'https://corsproxy.io/?' + encodeURIComponent(yahooUrl);
                const r = await fetch(url);
                if(!r.ok){
                    console.log(symbol + ' HTTP ' + r.status);
                    return null;
                }
                const j = await r.json();
                if(!j.chart || !j.chart.result || !j.chart.result[0]){
                    console.log(symbol + ' no chart data');
                    return null;
                }
                const timestamps = j.chart.result[0].timestamp;
                const quotes = j.chart.result[0].indicators.quote[0];
                const closes = quotes.close || quotes.adjclose || [];
                const dates = timestamps.map(ts => new Date(ts * 1000).toISOString().slice(0, 10));
                const marketCaps = closes.map((close, i) => close ? (close * shares[symbol] / 1e12) : null).filter(c => c !== null);
                console.log(symbol + ': ' + marketCaps.length + ' days');
                return { dates: dates.slice(0, marketCaps.length), marketCaps, symbol };
            } catch(e) {
                console.log('Fetch error ' + symbol + ':', e.message);
                return null;
            }
        }

        (async function() {
            console.log('=== 90일 시총 그래프 시작 (3개월) ===');
            const res = await Promise.all(symbols.map(fetchHistory));
            
            const validRes = res.filter(r => r && r.marketCaps.length > 60);  // 최소 60일 데이터
            console.log('Valid (60+ days):', validRes.map(r=>r.symbol));
            
            if(validRes.length < 3) {
                document.body.innerHTML = '<h1 style="color:red;text-align:center;margin-top:200px;">❌ 데이터 부족 (' + validRes.length + '/10)<br><small>F12 콘솔 확인 또는 VPN 사용</small></h1>';
                return;
            }

            const allDates = [...new Set(validRes.flatMap(r => r.dates))].sort();
            const labels = allDates.slice(-180);  // 최대 180일 표시 제한
            
            const datasets = validRes.map((r, i) => {
                const data = labels.map(d => {
                    const idx = r.dates.indexOf(d);
                    return idx > -1 ? r.marketCaps[idx] : null;
                });
                return {
                    label: names[r.symbol] || r.symbol,
                    data: data,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 1,
                    pointHoverRadius: 5
                };
            });

            new Chart(document.getElementById('marketCapChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top', 
                            labels: { usePointStyle: true, font: { size: 12 }, padding: 15 },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const dataset = ci.data.datasets[index];

                                // 상태 추적을 위한 커스텀 변수 (toggleState)
                                // 0: 초기 보통 상태
                                // 1: 두꺼움 (강조)
                                // 2: 다시 보통 (두꺼움 -> 보통)
                                // 3: 숨김
                                if (dataset.toggleState === undefined) {
                                    dataset.toggleState = 0;
                                }

                                let nextState;
                                
                                // 순환 로직: 보통(0) -> 두꺼움(1) -> 보통(2) -> 숨김(3) -> 두꺼움(1) ...
                                if (dataset.toggleState === 0) nextState = 1;
                                else if (dataset.toggleState === 1) nextState = 2;
                                else if (dataset.toggleState === 2) nextState = 3;
                                else if (dataset.toggleState === 3) nextState = 1;

                                // 상태 적용
                                if (nextState === 1) {
                                    // 두꺼워짐
                                    dataset.borderWidth = 8;
                                    ci.setDatasetVisibility(index, true);
                                } else if (nextState === 2) {
                                    // 보통 두께로 복귀
                                    dataset.borderWidth = 3;
                                    ci.setDatasetVisibility(index, true);
                                } else if (nextState === 3) {
                                    // 사라짐 (숨김)
                                    ci.setDatasetVisibility(index, false);
                                    // 숨겨진 상태에서도 borderWidth는 3으로 리셋해두면 좋음 (다음 나타날때 대비)
                                    dataset.borderWidth = 3; 
                                }

                                // 상태 저장 및 차트 업데이트
                                dataset.toggleState = nextState;
                                ci.update();
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: ctx => ctx[0].label,
                                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(2)}조 달러`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            title: { display: true, text: '시총 (Trillion USD)' },
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { callback: v => (v || 0).toFixed(2) + 'T' }
                        },
                        x: { 
                            title: { display: true, text: '날짜 (최근 90일+α)' },
                            ticks: { maxTicksLimit: 15 }
                        }
                    },
                    interaction: { mode: 'nearest', intersect: false }
                }
            });
            console.log('✅ 90일 그래프 렌더링 완료!');
        })();
    </script>
</body>
</html>