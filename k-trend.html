<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ ì£¼ì‹ ìˆ˜ìµë¥  ë¹„êµ (ìƒíƒœ ì €ì¥ í¬í•¨)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Malgun Gothic", sans-serif; margin: 0; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        
        .nav-bar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .nav-link { 
            text-decoration: none; color: #555; padding: 8px 12px; 
            border: 1px solid #ddd; border-radius: 5px; background: #fff; 
            display: flex; align-items: center; gap: 6px; font-size: 14px; transition: all 0.2s;
        }
        .nav-link.active { background: #007bff; color: white; border-color: #007bff; }

        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input[type="text"] { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; flex-grow: 1; }
        button.add-btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; white-space: nowrap; }

        .custom-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .legend-item { 
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; 
            padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; 
            transition: all 0.2s; user-select: none; min-width: 180px;
        }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; }
        .legend-info { display: flex; flex-direction: column; font-size: 13px; width: 100%; }
        .legend-name { font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; }
        .legend-close { color: #999; font-size: 16px; }

        .legend-item.hidden { opacity: 0.4; filter: grayscale(100%); }
        .legend-item.highlighted { border: 2px solid #333; background: #fff; }

        .chart-container { position: relative; height: 60vh; width: 100%; }
        #statusMessage { text-align: center; margin-bottom: 10px; height: 20px; }

        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .reset-btn { background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .hide-all-btn { background: #dc3545; }
        
        .text-up { color: #d60000; font-weight: bold; }
        .text-down { color: #0051c7; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-bar">
            <a href="index.html" class="nav-link"><i class="fas fa-home"></i> í†µí•© ë·°</a>
            <a href="rebalancing.html" class="nav-link"><i class="fas fa-balance-scale"></i> ë¦¬ë°¸ëŸ°ì‹±</a>
            <a href="trend.html" class="nav-link"><i class="fas fa-chart-line"></i> US ìˆ˜ìµë¥ </a>
            <a href="k-trend.html" class="nav-link active"><i class="fas fa-won-sign"></i> KR ìˆ˜ìµë¥ </a>
            <a href="top_chart.html" class="nav-link"><i class="fas fa-trophy"></i> ì‹œì´ Top</a>
        </div>

        <div class="nav-header">
            <h2>ğŸ“ˆ í•œêµ­ ì£¼ì‹ ìˆ˜ìµë¥  ë¹„êµ</h2>
            <div style="display: flex; gap: 8px;">
                <button class="reset-btn" onclick="resetLines()">âŸ² ë³´í†µì„ </button>
                <button class="reset-btn hide-all-btn" onclick="hideAllLines()">âŠ˜ ëª¨ë‘ ìˆ¨ê¹€</button>
            </div>
        </div>
        
        <p style="font-size: 0.9em; color: #666; margin-top:0;">ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ <b>ë³´í†µ â†’ ê°•ì¡° â†’ ìˆ¨ê¹€</b> ìˆœì„œë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div class="controls">
            <input type="text" id="symbolInput" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ(005930) ì…ë ¥" onkeypress="handleEnter(event)">
            <button class="add-btn" onclick="searchAndAddSymbol()">ì¶”ê°€</button>
        </div>

        <div id="customLegend" class="custom-legend"></div>
        <div id="statusMessage"></div>
        <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>

    <script>
        let myChart = null; let stockList = []; 
        const STORAGE_KEY = 'my_kstock_symbols_v2_state'; 
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#2E86C1', '#28B463'];

        window.onload = function() {
            loadSymbols();
            if (stockList.length === 0) {
                stockList = [{ code: '005930.KS', name: 'ì‚¼ì„±ì „ì', state: 0 }, { code: '000660.KS', name: 'SKí•˜ì´ë‹‰ìŠ¤', state: 0 }];
                saveSymbols();
            }
            updateChart();
        };

        function loadSymbols() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) stockList = JSON.parse(stored);
        }

        function saveSymbols() { localStorage.setItem(STORAGE_KEY, JSON.stringify(stockList)); }

        function resetLines() {
            stockList.forEach(s => s.state = 0); saveSymbols(); updateChart();
        }

        function hideAllLines() {
            stockList.forEach(s => s.state = 2); saveSymbols(); updateChart();
        }

        async function searchAndAddSymbol() {
            const input = document.getElementById('symbolInput');
            const val = input.value.trim(); if (!val) return;
            showMessage('ğŸ” ê²€ìƒ‰ ì¤‘...');
            const url = 'https://corsproxy.io/?' + encodeURIComponent(`https://query1.finance.yahoo.com/v1/finance/search?q=${val}&quotesCount=1`);
            try {
                const res = await fetch(url); const data = await res.json();
                if (data.quotes.length > 0) {
                    const q = data.quotes[0];
                    stockList.push({ code: q.symbol, name: q.shortname || q.symbol, state: 0 });
                    saveSymbols(); input.value = ''; updateChart();
                }
            } catch(e) { showMessage('âŒ ê²€ìƒ‰ ì‹¤íŒ¨', 'red'); }
        }

        function removeSymbol(code) {
            stockList = stockList.filter(s => s.code !== code); saveSymbols(); updateChart();
        }

        function showMessage(msg, color='black') {
            const el = document.getElementById('statusMessage'); el.style.color = color; el.innerText = msg;
        }

        async function fetchStockData(s) {
            const dtEnd = Math.floor(Date.now() / 1000); const dtStart = dtEnd - (95 * 24 * 60 * 60);
            const url = 'https://corsproxy.io/?' + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${s.code}?period1=${dtStart}&period2=${dtEnd}&interval=1d`);
            try {
                const res = await fetch(url); const json = await res.json();
                const result = json.chart.result[0];
                return { ...s, dates: result.timestamp.map(t => new Date(t*1000).toISOString().slice(0, 10)), prices: result.indicators.quote[0].close };
            } catch(e) { return null; }
        }

        async function updateChart() {
            const results = await Promise.all(stockList.map(fetchStockData));
            const valid = results.filter(r => r && r.prices);
            const labels = Array.from(new Set(valid.flatMap(r => r.dates))).sort();
            const datasets = valid.map((r, i) => {
                const base = r.prices.find(p => p !== null);
                return {
                    label: r.name, code: r.code, data: labels.map(d => {
                        const idx = r.dates.indexOf(d);
                        return idx > -1 && r.prices[idx] ? ((r.prices[idx] - base) / base) * 100 : null;
                    }),
                    borderColor: colors[i % colors.length], borderWidth: r.state === 1 ? 6 : 2,
                    hidden: r.state === 2, viewState: r.state, originPrice: base, currentPrice: r.prices[r.prices.length-1]
                };
            });
            drawChart(labels, datasets); generateCustomLegend(datasets);
            showMessage('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'green'); setTimeout(() => showMessage(''), 2000);
        }

        function drawChart(labels, datasets) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line', data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function generateCustomLegend(datasets) {
            const container = document.getElementById('customLegend'); container.innerHTML = '';
            datasets.forEach((ds, i) => {
                const rate = ((ds.currentPrice - ds.originPrice) / ds.originPrice * 100).toFixed(1);
                const div = document.createElement('div');
                div.className = `legend-item ${ds.viewState === 1 ? 'highlighted' : ds.viewState === 2 ? 'hidden' : ''}`;
                div.innerHTML = `<div class="legend-color-box" style="background:${ds.borderColor}"></div>
                    <div class="legend-info"><div class="legend-name">${ds.label}<span class="legend-close" onclick="event.stopPropagation(); removeSymbol('${ds.code}')">Ã—</span></div>
                    <div class="legend-prices">${ds.originPrice.toLocaleString()} â–¶ <span class="${rate >= 0 ? 'text-up' : 'text-down'}">${ds.currentPrice.toLocaleString()} (${rate}%)</span></div></div>`;
                div.onclick = () => {
                    const s = stockList.find(x => x.code === ds.code);
                    s.state = (s.state + 1) % 3; saveSymbols(); updateChart();
                };
                container.appendChild(div);
            });
        }
        function handleEnter(e) { if (e.key === 'Enter') searchAndAddSymbol(); }
    </script>
</body>
</html>