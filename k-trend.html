<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ ì£¼ì‹ ìˆ˜ìµë¥  ë¹„êµ (ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ & ìƒì„¸ ë ˆì „ë“œ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Malgun Gothic", sans-serif; margin: 0; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input[type="text"] { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; flex-grow: 1; }
        button.add-btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; white-space: nowrap; }
        button.add-btn:hover { background: #0056b3; }

        /* ì»¤ìŠ¤í…€ ë ˆì „ë“œ ìŠ¤íƒ€ì¼ */
        .custom-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .legend-item { 
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; 
            padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; 
            transition: all 0.2s; user-select: none; min-width: 180px;
        }
        .legend-item:hover { background: #e2e6ea; transform: translateY(-2px); }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        
        .legend-info { display: flex; flex-direction: column; font-size: 13px; line-height: 1.3; width: 100%; }
        .legend-name { font-weight: bold; font-size: 15px; color: #333; display: flex; justify-content: space-between; }
        .legend-close { color: #999; font-weight: normal; margin-left: 8px; font-size: 16px; }
        .legend-close:hover { color: #dc3545; }
        
        .legend-prices { margin-top: 4px; color: #666; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .price-arrow { color: #999; font-size: 10px; }
        
        /* í•œêµ­ ì£¼ì‹ ìƒ‰ìƒ: ìƒìŠ¹=ë¹¨ê°•, í•˜ë½=íŒŒë‘ */
        .text-up { color: #d60000; font-weight: bold; }
        .text-down { color: #0051c7; font-weight: bold; }
        .text-flat { color: #666; }

        /* ë ˆì „ë“œ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .legend-item.hidden { opacity: 0.4; filter: grayscale(100%); }
        .legend-item.highlighted { border: 2px solid #333; box-shadow: 0 2px 8px rgba(0,0,0,0.15); background: #fff; }

        .chart-container { position: relative; height: 60vh; width: 100%; }
        #statusMessage { text-align: center; margin-bottom: 10px; font-size: 14px; height: 20px; }

        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; font-size: 1.5rem; word-break: keep-all; }
        
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-header">
            <h2>ğŸ“ˆ í•œêµ­ ì£¼ì‹ ìˆ˜ìµë¥  ë¹„êµ</h2>
        </div>
        
        <p style="font-size: 0.9em; color: #666; margin-top:0;">ë²”ë¡€ë¥¼ í´ë¦­í•˜ì—¬ <b>ê°•ì¡°(êµµê²Œ) â†’ ë³´í†µ â†’ ìˆ¨ê¹€</b> ìˆœì„œë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div class="controls">
            <input type="text" id="symbolInput" placeholder="ì¢…ëª©ëª…(ì˜ˆ: ì‚¼ì„±ì „ì) ë˜ëŠ” ì½”ë“œ(005930) ì…ë ¥" onkeypress="handleEnter(event)">
            <button class="add-btn" onclick="searchAndAddSymbol()">ì¶”ê°€</button>
        </div>

        <div id="customLegend" class="custom-legend"></div>
        
        <div id="statusMessage"></div>

        <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>

    <script>
        let myChart = null;
        // symbols êµ¬ì¡° ë³€ê²½: ë‹¨ìˆœ ë¬¸ìì—´ ë°°ì—´ì´ ì•„ë‹ˆë¼ ê°ì²´ ë°°ì—´ë¡œ ê´€ë¦¬í•˜ì—¬ 'ì´ë¦„'ê³¼ 'ì½”ë“œ'ë¥¼ ëª¨ë‘ ê¸°ì–µí•¨
        // ì˜ˆ: { code: '005930.KS', name: 'ì‚¼ì„±ì „ì' }
        let stockList = []; 
        const STORAGE_KEY = 'my_kstock_symbols_v1'; 
        
        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', 
            '#2E86C1', '#28B463', '#D35400', '#884EA0', '#839192', '#F1C40F'
        ];

        window.onload = function() {
            loadSymbols();
            if (stockList.length === 0) {
                // ì´ˆê¸°ê°’: ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤, NAVER
                stockList = [
                    { code: '005930.KS', name: 'ì‚¼ì„±ì „ì' },
                    { code: '000660.KS', name: 'SKí•˜ì´ë‹‰ìŠ¤' },
                    { code: '035420.KS', name: 'NAVER' }
                ];
                saveSymbols();
            }
            updateChart();
        };

        function loadSymbols() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) stockList = JSON.parse(stored);
        }

        function saveSymbols() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stockList));
        }

        function handleEnter(e) { if (e.key === 'Enter') searchAndAddSymbol(); }

        // ê²€ìƒ‰ ë° ì¶”ê°€ ë¡œì§ (í•µì‹¬ ë³€ê²½ ì‚¬í•­)
        async function searchAndAddSymbol() {
            const input = document.getElementById('symbolInput');
            const val = input.value.trim();
            if (!val) return;

            showMessage('ğŸ” ê²€ìƒ‰ ì¤‘...', '#007bff');

            // 1. ì´ë¯¸ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
            const exists = stockList.some(item => item.code === val || item.name === val || item.code.startsWith(val));
            if (exists) {
                showMessage('âš ï¸ ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” ì¢…ëª©ì…ë‹ˆë‹¤.', 'orange');
                return;
            }

            let symbolToAdd = null;
            let nameToAdd = null;

            // 2. ì…ë ¥ê°’ì´ 6ìë¦¬ ìˆ«ìë¼ë©´ (ì¢…ëª©ì½”ë“œ ì§ì ‘ ì…ë ¥)
            if (/^\d{6}$/.test(val)) {
                // ê¸°ë³¸ì ìœ¼ë¡œ ì½”ìŠ¤í”¼(.KS) ì‹œë„ í›„ ì‹¤íŒ¨ì‹œ ì½”ìŠ¤ë‹¥(.KQ)ì€ ë°ì´í„° fetch ë‹¨ê³„ì—ì„œ íŒë³„í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ
                // Yahoo Search APIë¥¼ í†µí•´ ì •í™•í•œ í‹°ì»¤ í™•ì¸
                try {
                    const searchResult = await callYahooSearchApi(val);
                    if (searchResult) {
                        symbolToAdd = searchResult.symbol;
                        nameToAdd = searchResult.shortname || searchResult.longname;
                    } else {
                        // ê²€ìƒ‰ ì•ˆë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ KSë¡œ ê°€ì •
                        symbolToAdd = val + '.KS'; 
                        nameToAdd = val;
                    }
                } catch(e) {
                    symbolToAdd = val + '.KS';
                    nameToAdd = val;
                }
            } 
            // 3. ì…ë ¥ê°’ì´ ë¬¸ìë¼ë©´ (ì¢…ëª©ëª… ê²€ìƒ‰)
            else {
                try {
                    const result = await callYahooSearchApi(val);
                    if (result) {
                        symbolToAdd = result.symbol;
                        // í•œêµ­ ì¢…ëª©ì€ ë³´í†µ 000000.KS í˜•ì‹ì´ë¯€ë¡œ í•œêµ­ ì´ë¦„ ì‚¬ìš©
                        nameToAdd = result.shortname || result.longname; 
                    } else {
                        showMessage(`âŒ '${val}'ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'red');
                        return;
                    }
                } catch (e) {
                    showMessage('âŒ ê²€ìƒ‰ í†µì‹  ì˜¤ë¥˜', 'red');
                    return;
                }
            }

            // ì¤‘ë³µ ì¬í™•ì¸ (API ê²°ê³¼ ì½”ë“œë¡œ)
            if (stockList.some(s => s.code === symbolToAdd)) {
                showMessage('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¢…ëª©ì…ë‹ˆë‹¤.', 'orange');
                input.value = '';
                return;
            }

            // ì¶”ê°€
            stockList.push({ code: symbolToAdd, name: nameToAdd });
            saveSymbols();
            input.value = '';
            updateChart();
        }

        // Yahoo Search API í˜¸ì¶œ
        async function callYahooSearchApi(query) {
            // Yahoo Finance Search API (í•œêµ­ ì£¼ì‹ ìš°ì„  ê²€ìƒ‰)
            const yahooSearchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=1&newsCount=0&enableFuzzyQuery=false&quotesQueryId=tss_match_eq_basic`;
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(yahooSearchUrl);
            
            const res = await fetch(proxyUrl);
            const data = await res.json();
            
            if (data.quotes && data.quotes.length > 0) {
                return data.quotes[0]; // ê°€ì¥ ì •í™•í•œ ì²« ë²ˆì§¸ ê²°ê³¼ ë°˜í™˜
            }
            return null;
        }

        function removeSymbol(code) {
            stockList = stockList.filter(s => s.code !== code);
            saveSymbols();
            updateChart();
        }

        function showMessage(msg, color='black') {
            const el = document.getElementById('statusMessage');
            el.style.color = color;
            el.innerText = msg;
        }

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchStockData(stockObj) {
            const symbol = stockObj.code;
            // 3ê°œì›” ë°ì´í„° (ì•½ 95ì¼)
            const dtEnd = Math.floor(Date.now() / 1000);
            const dtStart = dtEnd - (95 * 24 * 60 * 60); 
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${dtStart}&period2=${dtEnd}&interval=1d`;
            const url = 'https://corsproxy.io/?' + encodeURIComponent(yahooUrl);

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network Error');
                const json = await res.json();
                
                if(!json.chart || !json.chart.result) throw new Error('No Data');

                const result = json.chart.result[0];
                const timestamps = result.timestamp;
                const closes = result.indicators.quote[0].close;
                
                // ë©”íƒ€ë°ì´í„°ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ì‹œë„ (ì €ì¥ëœ ì´ë¦„ë³´ë‹¤ API ì´ë¦„ì´ ì •í™•í•  ìˆ˜ ìˆìŒ)
                // í•˜ì§€ë§Œ í•œê¸€ ê²€ìƒ‰ì‹œ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì €ì¥ëœ ì´ë¦„ ìš°ì„  ì‚¬ìš©
                const metaName = stockObj.name;

                const validPrices = [];
                const validDates = [];
                
                if(!timestamps || !closes) return null;

                closes.forEach((price, i) => {
                    if (price) {
                        validPrices.push(price);
                        validDates.push(new Date(timestamps[i] * 1000).toISOString().slice(0, 10));
                    }
                });

                if (validPrices.length === 0) return null;

                return { 
                    symbol: symbol, 
                    name: metaName, 
                    dates: validDates, 
                    prices: validPrices 
                };
            } catch (e) {
                console.error(e);
                showMessage(`âŒ ${stockObj.name || symbol} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨`, 'red');
                return null;
            }
        }

        async function updateChart() {
            if (stockList.length === 0) { 
                if(myChart) myChart.destroy(); 
                document.getElementById('customLegend').innerHTML = '';
                return; 
            }
            showMessage('â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', '#007bff');

            const results = await Promise.all(stockList.map(fetchStockData));
            const validResults = results.filter(r => r !== null);

            if (validResults.length === 0) { showMessage('ë°ì´í„° ì—†ìŒ', 'red'); return; }

            // ë‚ ì§œ ì •ë ¬
            const allDatesSet = new Set();
            validResults.forEach(r => r.dates.forEach(d => allDatesSet.add(d)));
            const sortedLabels = Array.from(allDatesSet).sort();

            const datasets = validResults.map((r, index) => {
                const basePrice = r.prices[0];
                const lastPrice = r.prices[r.prices.length - 1];
                
                const data = sortedLabels.map(d => {
                    const idx = r.dates.indexOf(d);
                    return idx > -1 ? ((r.prices[idx] - basePrice) / basePrice) * 100 : null;
                });

                const color = colors[index % colors.length];

                return {
                    label: r.name, // ì°¨íŠ¸ íˆ´íŒìš©
                    code: r.symbol, // ì‹ë³„ìš©
                    data: data,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 2, 
                    pointRadius: 0,
                    pointHoverRadius: 4, 
                    tension: 0.3,
                    fill: false,
                    // ì»¤ìŠ¤í…€ ë°ì´í„° (ë ˆì „ë“œ í‘œì‹œìš©)
                    originPrice: basePrice,
                    currentPrice: lastPrice,
                    toggleState: 0 // 0:ë³´í†µ, 1:ê°•ì¡°, 2:ìˆ¨ê¹€ (ë¡œì§ ìƒ 0->1->0ë³µê·€->2ìˆ¨ê¹€->1ê°•ì¡° ìˆœí™˜ ë“±ìœ¼ë¡œ êµ¬í˜„)
                };
            });

            drawChart(sortedLabels, datasets);
            generateCustomLegend(datasets); // ì°¨íŠ¸ ìƒì„± í›„ HTML ë ˆì „ë“œ ìƒì„±
            showMessage('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'green');
            setTimeout(() => showMessage(''), 2000);
        }

        function drawChart(labels, datasets) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false }, // ê¸°ë³¸ ë ˆì „ë“œ ìˆ¨ê¹€
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const val = ctx.parsed.y?.toFixed(2);
                                    return `${ctx.dataset.label}: ${val}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: c => c.tick.value === 0 ? '#666' : '#eee', lineWidth: c => c.tick.value === 0 ? 1.5 : 1 },
                            ticks: { callback: v => v + '%' }
                        },
                        x: { display: false } // Xì¶• ë‚ ì§œ ìˆ¨ê¹€ (ê¹”ë”í•˜ê²Œ)
                    }
                }
            });
        }

        // ============================================
        // â˜… í•µì‹¬ ê¸°ëŠ¥: ìƒì„¸ ì •ë³´ë¥¼ ë‹´ì€ HTML ë ˆì „ë“œ ìƒì„±
        // ============================================
        function generateCustomLegend(datasets) {
            const container = document.getElementById('customLegend');
            container.innerHTML = '';

            datasets.forEach((ds, index) => {
                const startP = ds.originPrice;
                const endP = ds.currentPrice;
                const diff = endP - startP;
                const diffRate = ((diff / startP) * 100).toFixed(1);
                
                // í•œêµ­ì‹ ìƒ‰ìƒ: ìƒìŠ¹(ë¹¨ê°•), í•˜ë½(íŒŒë‘)
                const priceClass = diff >= 0 ? 'text-up' : 'text-down';
                const sign = diff >= 0 ? '+' : '';

                const div = document.createElement('div');
                div.className = 'legend-item';
                div.dataset.index = index;
                
                // ë ˆì „ë“œ ë‚´ìš© êµ¬ì„±
                div.innerHTML = `
                    <div class="legend-color-box" style="background:${ds.borderColor}"></div>
                    <div class="legend-info">
                        <div class="legend-name">
                            ${ds.label}
                            <span class="legend-close" onclick="event.stopPropagation(); removeSymbol('${ds.code}')">Ã—</span>
                        </div>
                        <div class="legend-prices">
                            <span>${startP.toLocaleString()}</span>
                            <span class="price-arrow">â–¶</span>
                            <span class="${priceClass}">${endP.toLocaleString()} (${sign}${diffRate}%)</span>
                        </div>
                    </div>
                `;

                // í´ë¦­ ì´ë²¤íŠ¸ (ìƒíƒœ ìˆœí™˜)
                div.onclick = () => toggleDataset(index, div);
                container.appendChild(div);
            });
        }

        function toggleDataset(index, element) {
            const ci = myChart;
            const ds = ci.data.datasets[index];
            
            // ìƒíƒœ ì´ˆê¸°í™”
            if (ds.toggleState === undefined) ds.toggleState = 0;

            // ìˆœí™˜ ë¡œì§: 0(ë³´í†µ) -> 1(ê°•ì¡°) -> 2(ë³´í†µ ë³µê·€) -> 3(ìˆ¨ê¹€) -> 1(ê°•ì¡°) ... 
            // ì‚¬ìš©ìì˜ ìš”ì²­ íë¦„: ê°•ì¡° -> ë³´í†µ -> ìˆ¨ê¹€
            let nextState;
            const current = ds.toggleState;

            if (current === 0) nextState = 1;      // ë³´í†µ -> ê°•ì¡°
            else if (current === 1) nextState = 0; // ê°•ì¡° -> ë³´í†µ
            else if (current === 0) nextState = 3; // (ë¡œì§ìƒ ì´ë ‡ê²Œ ê°ˆìˆ˜ì—†ìœ¼ë¯€ë¡œ ì¡°ì •) 
            // ì‹¤ì œ êµ¬í˜„: í´ë¦­í• ë•Œë§ˆë‹¤ ìˆœí™˜
            // 0(Normal) -> 1(Highlight) -> 2(Hidden) -> 0(Normal)
            
            // ê¸°ì¡´ ì½”ë“œì˜ 3ë‹¨ê³„ ë¡œì§ì„ HTML í´ë˜ìŠ¤ì™€ ë§¤í•‘
            if (current === 0) nextState = 1;
            else if (current === 1) nextState = 2; // ë³´í†µìœ¼ë¡œ ëŒì•„ê°€ê¸°ìœ„í•´ ìƒíƒœê°’ ì¡°ì •í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„  2ë¥¼ ë³´í†µìœ¼ë¡œ ì“°ì§€ ì•Šê³  ìˆ¨ê¹€ìœ¼ë¡œ ì“°ê² ìŒ? 
            // ìš”ì²­ì‚¬í•­: ê°•ì¡° -> ë³´í†µ -> ìˆ¨ê¹€ ìˆœì„œ.
            // 0:ë³´í†µ, 1:ê°•ì¡°, 2:ìˆ¨ê¹€
            if (current === 0) nextState = 1; // ê°•ì¡°
            else if (current === 1) nextState = 0; // ë³´í†µ (ê°•ì¡° í•´ì œ) -> UXìƒ ë°”ë¡œ ìˆ¨ê¹€ìœ¼ë¡œ ê°€ëŠ”ê²Œ ì•„ë‹ˆë¼ ë³´í†µì„ ê±°ì¹˜ëŠ”ê²Œ ìì—°ìŠ¤ëŸ¬ì›€
            // ì•„ë‹ˆë©´ ìš”ì²­ëŒ€ë¡œ: ê°•ì¡° -> ë³´í†µ -> ìˆ¨ê¹€ -> ê°•ì¡°?
            // ì‘ì„±ì ì˜ë„ íŒŒì•…: ê°•ì¡° -> ë³´í†µ -> ìˆ¨ê¹€ -> (ë‹¤ì‹œ 0)
            
            // ì¬ì •ì˜:
            // State 0: Normal (ë³´í†µ)
            // State 1: Highlight (ê°•ì¡°)
            // State 2: Hidden (ìˆ¨ê¹€)
            
            if (current === 0) nextState = 1;
            else if (current === 1) nextState = 0; // ì´ ë¶€ë¶„ì€ ê°•ì¡° í•´ì œë˜ì–´ ë³´í†µì´ ë¨. ê·¸ ë‹¤ìŒ í´ë¦­ ì‹œ ìˆ¨ê¹€ì´ ë˜ì–´ì•¼ í•¨.
            // ì´ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ ìƒíƒœ ë³€ìˆ˜ê°€ í•˜ë‚˜ ë” í•„ìš”í•˜ê±°ë‚˜ ìƒíƒœ ìˆœì„œë¥¼ ëª…í™•íˆ í•´ì•¼ í•¨.
            // State Flow: 0(Init) -> 1(Bold) -> 0(Normal, but mark as visited?) 
            // ê°„ë‹¨í•˜ê²Œ: 0(ë³´í†µ) -> 1(ê°•ì¡°) -> 2(ìˆ¨ê¹€) -> 0(ë³´í†µ) ìœ¼ë¡œ ìˆœí™˜
            
            if (current === 0) nextState = 1;
            else if (current === 1) nextState = 0; // ê°•ì¡° -> ë³´í†µ
            // ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí•¨. ë³´í†µì—ì„œ í´ë¦­í•˜ë©´ ê°•ì¡°ê°€ ë¨.
            // ê°•ì¡° -> ë³´í†µì´ ëœ ì§í›„ì— í´ë¦­í•˜ë©´ ë‹¤ì‹œ ê°•ì¡°ê°€ ë¨. ìˆ¨ê¹€ìœ¼ë¡œ ê°€ì§€ ì•ŠìŒ.
            // ë”°ë¼ì„œ ë³„ë„ í”Œë˜ê·¸ê°€ í•„ìš”í•¨.
            
            // ê°œì„ ëœ ë¡œì§: 3-state counter
            // stateValue: 0(ë³´í†µ), 1(ê°•ì¡°), 2(ìˆ¨ê¹€)
            
            ds.stateCounter = (ds.stateCounter || 0) + 1;
            const mode = ds.stateCounter % 3; // 1(ê°•ì¡°), 2(ë³´í†µ?), 0(ìˆ¨ê¹€?) -> ìˆœì„œ ë§ì¶”ê¸° ì–´ë ¤ì›€.
            
            // ì§ê´€ì ì¸ ìˆœì„œ ê°•ì œ ì§€ì •:
            // í˜„ì¬ ìƒíƒœê°€ 0(ë³´í†µ)ì´ê³  ì´ì „ì´ ìˆ¨ê¹€ì´ì—ˆë‹¤ë©´ -> ê°•ì¡°
            // ë³µì¡í•˜ë¯€ë¡œ ë‹¨ìˆœí™”: 
            // í´ë˜ìŠ¤ ë¦¬ìŠ¤íŠ¸ í™•ì¸
            
            if (element.classList.contains('highlighted')) {
                // í˜„ì¬ ê°•ì¡° ìƒíƒœ -> ë³´í†µìœ¼ë¡œ
                element.classList.remove('highlighted');
                ds.borderWidth = 2;
                ci.setDatasetVisibility(index, true);
                ds.toggleState = 0; // ë³´í†µ
                // ë³´í†µì—ì„œ ë‹¤ìŒ í´ë¦­ ì‹œ ìˆ¨ê¹€ìœ¼ë¡œ ê°€ê¸° ìœ„í•´ ì„ì‹œ ìƒíƒœê°€ í•„ìš”í•˜ì§€ë§Œ,
                // UIì ìœ¼ë¡œ "ê°•ì¡° -> ë³´í†µ -> ìˆ¨ê¹€"ì„ ìˆœì°¨ì ìœ¼ë¡œ í•˜ë ¤ë©´:
                // ë³€ìˆ˜ ê°’: 0(Start) -> 1(High) -> 2(Normal_ReadyToHide) -> 3(Hidden) -> 1...
            } else if (element.classList.contains('hidden')) {
                // í˜„ì¬ ìˆ¨ê¹€ ìƒíƒœ -> ê°•ì¡°ë¡œ (í˜¹ì€ ë³´í†µìœ¼ë¡œ)
                element.classList.remove('hidden');
                // ë°”ë¡œ ê°•ì¡°ë¡œ? ì•„ë‹ˆë©´ ë³´í†µìœ¼ë¡œ? -> ë³´í†µìœ¼ë¡œ ë³µê·€ê°€ ì¼ë°˜ì 
                ds.borderWidth = 2;
                ci.setDatasetVisibility(index, true);
                ds.toggleState = 0;
            } else {
                // í˜„ì¬ ë³´í†µ ìƒíƒœ
                // ë§Œì•½ ì´ì „ì— ê°•ì¡°ì˜€ë‹¤ê°€ ëŒì•„ì˜¨ê±°ë©´ ìˆ¨ê¹€ìœ¼ë¡œ, ì²˜ìŒì´ë©´ ê°•ì¡°ë¡œ?
                // í—·ê°ˆë¦¬ë¯€ë¡œ ë‹¨ìˆœ í† ê¸€: ë³´í†µ -> ê°•ì¡° -> ìˆ¨ê¹€ -> ë³´í†µ
                if (ds.toggleState === 0) {
                    // ë³´í†µ -> ê°•ì¡°
                    element.classList.add('highlighted');
                    ds.borderWidth = 6; // ì„  êµµê²Œ
                    // ë‹¤ë¥¸ ë°ì´í„°ì…‹ ì—°í•˜ê²Œ ì²˜ë¦¬í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ ê°€ëŠ¥
                    ci.setDatasetVisibility(index, true);
                    ds.toggleState = 1;
                } else if (ds.toggleState === 2) { // ìˆ¨ê¹€ì´ì—ˆë‹¤ê°€ ë³´í†µëœ ì§í›„ (ìœ„ ë¡œì§ì— ì˜í•´ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë¨)
                     // pass
                }
            }
            
            // ë¡œì§ ì¬ì •ë¦¬ (ë‹¨ìˆœ ìŠ¤í…Œì´íŠ¸ ë¨¸ì‹  ì‚¬ìš©)
            // 0: Normal
            // 1: Highlighted
            // 2: Hidden
            
            let newState;
            if (ds.viewState === undefined) ds.viewState = 0; // ì´ˆê¸°ê°’ Normal

            if (ds.viewState === 0) { // Normal -> Highlight
                newState = 1;
            } else if (ds.viewState === 1) { // Highlight -> Normal
                newState = 0; 
                // ì—¬ê¸°ì„œ Normalë¡œ ê°€ë©´ ë‹¤ìŒ í´ë¦­ì‹œ ë‹¤ì‹œ Highlightê°€ ë¨.
                // "ë³´í†µ" ìƒíƒœê°€ ë‘ ë²ˆ(ì´ˆê¸°, ê°•ì¡°í›„ ë³µê·€) ì¡´ì¬í•´ì„œ ìƒê¸°ëŠ” ë¬¸ì œ.
                // íë¦„ì„ 0 -> 1 -> 3(Normal_2) -> 2 -> 0 ìœ¼ë¡œ ì„¤ê³„
                newState = 3; 
            } else if (ds.viewState === 3) { // Normal_2 -> Hidden
                newState = 2;
            } else if (ds.viewState === 2) { // Hidden -> Normal (or Highlight?)
                newState = 0; // ë‹¤ì‹œ ì²˜ìŒìœ¼ë¡œ
            }

            // ì ìš©
            element.classList.remove('highlighted', 'hidden');
            
            if (newState === 0 || newState === 3) { // Normal
                ds.borderWidth = 2;
                ci.setDatasetVisibility(index, true);
            } else if (newState === 1) { // Highlight
                element.classList.add('highlighted');
                ds.borderWidth = 8;
                // z-index ì¡°ì •ì„ ìœ„í•´ ë°ì´í„°ì…‹ ìˆœì„œë¥¼ ë°”ê¿€ ìˆœ ì—†ìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ 
                ci.setDatasetVisibility(index, true);
            } else if (newState === 2) { // Hidden
                element.classList.add('hidden');
                ci.setDatasetVisibility(index, false);
            }

            ds.viewState = newState;
            ci.update();
        }

    </script>
</body>
</html>